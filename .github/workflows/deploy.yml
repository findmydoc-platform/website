name: CI & CD

permissions:
  contents: read
  pull-requests: write

# Prevent concurrent runs on the same PR or branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '!**/.github/workflows/**'
      - '**/.github/dependabot.yml'
      - '**/*.md'
      - '**/.github/instructions/**'
      - '**/.github/prompts/**'
      - '**/copilot-instructions.md'
      - '**/.vscode/settings.json'
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  NODE_VERSION: 22
  PNPM_VERSION: 10.12.3
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  NEXT_TELEMETRY_DISABLED: 1

defaults:
  run:
    shell: bash

jobs:
  paths:
    name: ðŸ§­ Path Filter
    runs-on: ubuntu-latest
    outputs:
      deployable: ${{ steps.set-deployable.outputs.deployable }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Evaluate deployable changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            deployable:
              - '**'
              - '!docs/**'
              - '!tests/**'
              - '!.storybook/**'
              - '!src/stories/**'
              - '!**/*.stories.{ts,tsx}'
              - '!**/*.md'

      - name: Set deployable output
        id: set-deployable
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "deployable=true" >> "$GITHUB_OUTPUT"
          else
            echo "deployable=${{ steps.filter.outputs.deployable }}" >> "$GITHUB_OUTPUT"
          fi

  ci:
    name: âœ… Check & Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-

      - name: Install dependencies
        run: pnpm install

      - name: Generate permission matrix JSON
        run: pnpm matrix:derive json

      - name: Verify permission matrix alignment
        run: pnpm matrix:verify

      - name: Check migrations
        run: |
          if git diff --quiet origin/main HEAD -- src/migrations/; then
            echo "No migrations changed."
          else
            echo "ðŸš¨ Migration scripts changed!"
          fi

      - name: Lint
        id: lint
        run: pnpm lint

      - name: Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install chromium

      - name: Run unit tests
        id: vitest
        run: pnpm vitest --project unit --run --coverage

      - name: Run Storybook tests
        id: storybook
        if: ${{ steps.vitest.outcome == 'success' || steps.vitest.outcome == 'failure' }}
        run: pnpm vitest --project storybook --run --coverage

      - name: Publish Unit Test coverage
        if: ${{ steps.vitest.outcome == 'success' || steps.vitest.outcome == 'failure' }}
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vite-config-path: .github/coverage/vitest.thresholds.unit.js
          name: Unit Tests
          file-coverage-mode: all
          json-summary-path: coverage/unit/coverage-summary.json
          json-final-path: coverage/unit/coverage-final.json

      - name: Publish Storybook coverage
        if: ${{ steps.storybook.outcome == 'success' || steps.storybook.outcome == 'failure' }}
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vite-config-path: .github/coverage/vitest.thresholds.storybook.js
          name: Storybook Tests
          file-coverage-mode: all
          json-summary-path: coverage/storybook/coverage-summary.json
          json-final-path: coverage/storybook/coverage-final.json

      - name: Generate job summary
        if: always()
        run: |
          echo "## CI Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint**: ${{ steps.lint.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests**: ${{ steps.vitest.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Storybook Tests**: ${{ steps.storybook.outcome }}" >> $GITHUB_STEP_SUMMARY

  build:
    name: ðŸ”¨ Build
    needs:
      - ci
      - paths
    if: github.event_name != 'pull_request' || needs.paths.outputs.deployable == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      PREVIEW_SECRET: ${{ secrets.PREVIEW_SECRET }}
      DATABASE_URI: postgresql://postgres:password@localhost:5432/findmydoc-portal
    services:
      postgres:
        image: postgis/postgis:15-3.3
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: findmydoc-portal
        options: >-
          --health-cmd "pg_isready -U postgres -h localhost -d postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Restore pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-

      - name: Install dependencies
        run: pnpm install

      # Note: Permission matrix already verified in CI job, skip here to save time

      - name: Wait for PostgreSQL service
        run: |
          echo "Waiting for PostgreSQL service container to become healthy..."
          for i in {1..30}; do
            status=$(docker inspect --format '{{.State.Health.Status}}' "${{ job.services.postgres.id }}")
            if [ "$status" = "healthy" ]; then
              echo "PostgreSQL is healthy!"
              exit 0
            fi
            echo "Attempt $i: PostgreSQL status is '$status'. Waiting 2 seconds..."
            sleep 2
          done
          echo "Error: PostgreSQL did not become healthy in time."
          docker inspect "${{ job.services.postgres.id }}" || true
          exit 1

      - name: Run database migrations
        run: |
          echo "Running database migrations..."
          pnpm run migrate

      - name: Build application (static check)
        run: pnpm build

      - name: Run integration tests
        id: integration_tests
        env:
          NODE_ENV: test
        run: pnpm vitest --project integration --run --coverage --reporter=verbose

      - name: Publish coverage summary
        if: ${{ steps.integration_tests.outcome == 'success' }}
        uses:  davelosert/vitest-coverage-report-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vite-config-path: .github/coverage/vitest.thresholds.integration.js
          name: Integration Tests
          file-coverage-mode: all
          json-summary-path: coverage/integration/coverage-summary.json
          json-final-path: coverage/integration/coverage-final.json

      - name: Generate job summary
        if: always()
        run: |
          echo "## Build Job Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration Tests**: ${{ steps.integration_tests.outcome }}" >> $GITHUB_STEP_SUMMARY


  Deploy-Preview:
    name: Deploy Preview
    if: (github.event_name == 'pull_request' || github.ref == 'refs/heads/main') && needs.paths.outputs.deployable == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - build
      - paths
    environment:
      name: Preview
      url: ${{ steps.vercel_preview.outputs.deploymentUrl }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Pull Vercel Environment Variables for Preview
        run: pnpm dlx vercel@canary pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel (Preview)
        id: vercel_preview
        run: |
          pnpm dlx vercel@canary deploy --target preview --token=${{ secrets.VERCEL_TOKEN }} >deployment-url.txt 2>error.txt

          code=$?
          if [ $code -eq 0 ]; then
              deploymentUrl=$(cat deployment-url.txt)
              echo "deploymentUrl=$deploymentUrl" >> "$GITHUB_OUTPUT"
              echo "âœ… Preview deployment successful: $deploymentUrl"
          else
              echo "âŒ There was an error during Vercel deployment:"
              cat error.txt
              exit $code
          fi

      # fixed url has to be manually set because Vercel does not automatically set it for preview deployments
      - name: Set Preview Alias
        run: |
          pnpm dlx vercel@canary alias set ${{ steps.vercel_preview.outputs.deploymentUrl }} findmydoc-portal-tst.vercel.app --token=${{ secrets.VERCEL_TOKEN }}

      - name: Generate deployment summary
        if: always()
        run: |
          echo "## Preview Deployment Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.vercel_preview.outcome }}" == "success" ]; then
            echo "âœ… **Status**: Success" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **URL**: ${{ steps.vercel_preview.outputs.deploymentUrl }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Alias**: https://findmydoc-portal-tst.vercel.app" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

  Deploy-Production:
    name: Deploy Production
    if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main' && needs.paths.outputs.deployable == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - build
      - Deploy-Preview
      - paths
    environment:
      name: Production
      url: ${{ steps.vercel_production.outputs.deploymentUrl }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Pull Vercel Environment Variables for Production
        run: pnpm dlx vercel@canary pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel (Production)
        id: vercel_production
        run: |
          pnpm dlx vercel@canary deploy --prod --token=${{ secrets.VERCEL_TOKEN }} >deployment-url.txt 2>error.txt

          # check the exit code
          code=$?
          if [ $code -eq 0 ]; then
              # Now you can use the deployment url from stdout for the next step of your workflow
              deploymentUrl=$(cat deployment-url.txt)
              echo "deploymentUrl=$deploymentUrl" >> "$GITHUB_OUTPUT"
              echo "âœ… Production deployment successful: $deploymentUrl"
          else
              # Handle the error
              errorMessage=$(cat error.txt)
              echo "âŒ There was an error: $errorMessage"
              exit $code
          fi

      - name: Generate deployment summary
        if: always()
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.vercel_production.outcome }}" == "success" ]; then
            echo "âœ… **Status**: Success" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **URL**: ${{ steps.vercel_production.outputs.deploymentUrl }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
